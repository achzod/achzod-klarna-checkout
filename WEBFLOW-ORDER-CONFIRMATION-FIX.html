<!--
===========================================
FIX PAGE ORDER CONFIRMATION WEBFLOW
===========================================

Ce script r√©cup√®re les donn√©es de la commande depuis notre API
et les affiche sur la page order-confirmation de Webflow.

INSTRUCTIONS:
1. Va dans Webflow > Project Settings > Custom Code
2. Colle ce script dans la section "Footer Code" de la page order-confirmation
3. Publie ton site

-->

<script>
(function() {
  // R√©cup√©rer session_id depuis l'URL (pour paiements Klarna/Stripe)
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session_id');
  const orderId = urlParams.get('orderId'); // Pour paiements Webflow normaux
  
  // Si c'est un paiement Webflow normal (avec orderId), ne rien faire
  if (orderId) {
    console.log('‚úÖ Commande Webflow normale, pas besoin de r√©cup√©rer depuis API');
    return;
  }
  
  // Si pas de session_id, c'est peut-√™tre une page vide ou erreur
  if (!sessionId) {
    console.log('‚ö†Ô∏è Pas de session_id ni orderId dans l\'URL - page peut √™tre vide');
    return;
  }

  console.log('üîç R√©cup√©ration donn√©es commande Klarna/Stripe pour session:', sessionId);

  // R√©cup√©rer les donn√©es de la commande depuis notre API
  fetch(`https://achzod-klarna-checkout.onrender.com/order-data?session_id=${sessionId}`)
    .then(response => response.json())
    .then(data => {
      if (!data.success) {
        console.error('‚ùå Erreur:', data.error);
        return;
      }

      console.log('‚úÖ Donn√©es commande re√ßues:', data);

      const order = data.order;
      const totalFormatted = `${order.total} ${order.currency === 'EUR' ? '‚Ç¨' : order.currency}`;
      
      // Fonction pour remplacer tous les montants $0.00 ou 0,00
      function replaceAmounts() {
        // Remplacer dans tous les √©l√©ments de texte
        const walker = document.createTreeWalker(
          document.body,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );
        
        const textNodes = [];
        let node;
        while (node = walker.nextNode()) {
          textNodes.push(node);
        }
        
        textNodes.forEach(textNode => {
          const text = textNode.textContent;
          // Chercher $0.00, ‚Ç¨ 0,00, 0,00 ‚Ç¨, 0.00, etc.
          if (text && (
            text.includes('$0.00') || 
            text.includes('‚Ç¨ 0,00') || 
            text.includes('0,00 ‚Ç¨') ||
            text.includes('0.00 ‚Ç¨') ||
            (text.match(/0[,.]00/) && (text.includes('TOTAL') || text.includes('Total') || text.includes('R√âGL√â')))
          )) {
            // Remplacer seulement si c'est dans un contexte de total
            if (text.includes('TOTAL') || text.includes('Total') || text.includes('R√âGL√â') || text.includes('Total')) {
              textNode.textContent = text.replace(/\$?0[,.]00\s*‚Ç¨?/g, totalFormatted);
            }
          }
        });
      }
      
      // Mettre √† jour les montants affich√©s (chercher tous les √©l√©ments possibles)
      const totalSelectors = [
        '.w-commerce-commercecheckoutsummarytotal',
        '[data-wf-bindings*="total"]',
        '.order-total',
        '.total-amount',
        '.checkout-total',
        'div[class*="total"]',
        'span[class*="total"]'
      ];
      
      totalSelectors.forEach(selector => {
        try {
          const elements = document.querySelectorAll(selector);
          elements.forEach(el => {
            const text = el.textContent || el.innerText || '';
            if (text.includes('$0.00') || text.includes('0,00') || text.includes('‚Ç¨ 0,00') || text.includes('0.00 ‚Ç¨') || text.includes('0.00')) {
              // V√©rifier si c'est vraiment un total (contient "TOTAL" ou "Total" ou "R√âGL√â")
              const parentText = el.parentElement ? el.parentElement.textContent : '';
              if (text.includes('TOTAL') || text.includes('Total') || text.includes('R√âGL√â') || parentText.includes('TOTAL') || parentText.includes('Total')) {
                el.textContent = totalFormatted;
                el.style.color = '#000';
                el.style.fontWeight = 'bold';
              }
            }
          });
        } catch (e) {
          // Ignorer les s√©lecteurs invalides
        }
      });
      
      // Chercher aussi dans les r√©capitulatifs de commande
      const summaryBlocks = document.querySelectorAll('.w-commerce-commercecheckoutsummaryblock, .order-summary, .checkout-summary, [class*="summary"]');
      summaryBlocks.forEach(block => {
        const blockText = block.textContent || '';
        if (blockText.includes('TOTAL') || blockText.includes('Total') || blockText.includes('R√âGL√â')) {
          // Chercher tous les √©l√©ments avec des montants
          const amountElements = block.querySelectorAll('div, span, p, td');
          amountElements.forEach(el => {
            const text = el.textContent || '';
            if ((text.includes('$0.00') || text.includes('0,00') || text.includes('‚Ç¨ 0,00')) && 
                (text.includes('TOTAL') || text.includes('Total') || text.includes('R√âGL√â') || el.parentElement?.textContent?.includes('TOTAL'))) {
              el.textContent = totalFormatted;
              el.style.fontWeight = 'bold';
            }
          });
        }
      });
      
      // Remplacer aussi dans tout le DOM
      replaceAmounts();

      // Mettre √† jour le sous-total
      const subtotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2);
      const subtotalFormatted = `${subtotal} ${order.currency === 'EUR' ? '‚Ç¨' : order.currency}`;
      const subtotalElements = document.querySelectorAll('[data-wf-bindings*="subtotal"], .cart-subtotal-text, [class*="subtotal"]');
      subtotalElements.forEach(el => {
        const text = el.textContent || '';
        if (text.includes('$0.00') || text.includes('0,00') || text.includes('‚Ç¨ 0,00')) {
          el.textContent = subtotalFormatted;
        }
      });

      // Mettre √† jour les prix des items
      const itemElements = document.querySelectorAll('.w-commerce-commercecheckoutorderitem, [class*="orderitem"]');
      itemElements.forEach((el, index) => {
        if (index < order.items.length) {
          const item = order.items[index];
          const priceEl = el.querySelector('.w-commerce-commercecheckoutorderitemprice, .checkout-price, [class*="price"]');
          if (priceEl) {
            const priceText = priceEl.textContent || '';
            if (priceText.includes('$0.00') || priceText.includes('0,00') || priceText.includes('‚Ç¨ 0,00')) {
              priceEl.textContent = `${(item.price * item.quantity).toFixed(2)} ${order.currency === 'EUR' ? '‚Ç¨' : order.currency}`;
            }
          }
        }
      });

      // Afficher les liens de t√©l√©chargement si des ebooks sont trouv√©s
      if (data.ebooks && data.ebooks.length > 0) {
        const downloadsSection = document.querySelector('.w-commerce-commercedownloadswrapper, .downloads, [class*="download"]');
        if (downloadsSection) {
          const downloadsList = downloadsSection.querySelector('.w-commerce-commercedownloadslist, .downloads-list, [class*="download"]');
          if (downloadsList) {
            // Vider la liste existante
            downloadsList.innerHTML = '';
            
            // Ajouter chaque ebook
            data.ebooks.forEach(ebook => {
              const item = document.createElement('div');
              item.className = 'w-commerce-commercedownloadsitem download-item';
              item.innerHTML = `
                <div class="download-text">${ebook.name}</div>
                <a href="${ebook.link}" target="_blank" class="download-button w-button">T√©l√©charger</a>
              `;
              downloadsList.appendChild(item);
            });
          }
        } else {
          // Cr√©er la section si elle n'existe pas
          const orderContainer = document.querySelector('.w-commerce-commerceorderconfirmationcontainer, .order-confirmation-container, [class*="confirmation"]');
          if (orderContainer) {
            const downloadsSection = document.createElement('div');
            downloadsSection.className = 'w-commerce-commercedownloadswrapper downloads';
            downloadsSection.style.marginTop = '20px';
            downloadsSection.style.padding = '20px';
            downloadsSection.style.backgroundColor = '#f5f5f5';
            downloadsSection.style.borderRadius = '8px';
            downloadsSection.innerHTML = `
              <div class="w-commerce-commercecheckoutsummaryblockheader block-header confirmation">
                <h4 class="checkout-section-headine" style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">T√©l√©chargez votre e-book</h4>
              </div>
              <fieldset class="w-commerce-commercecheckoutblockcontent">
                <div class="w-commerce-commercedownloadslist downloads-list">
                  ${data.ebooks.map(ebook => `
                    <div class="w-commerce-commercedownloadsitem download-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 10px; background: white; border-radius: 4px;">
                      <div class="download-text" style="font-weight: 500;">${ebook.name}</div>
                      <a href="${ebook.link}" target="_blank" class="download-button w-button" style="padding: 8px 16px; background: #0A0B09; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">T√©l√©charger</a>
                    </div>
                  `).join('')}
                </div>
              </fieldset>
            `;
            orderContainer.insertBefore(downloadsSection, orderContainer.firstChild);
          }
        }
      }

      console.log('‚úÖ Page mise √† jour avec les donn√©es de la commande');
    })
    .catch(error => {
      console.error('‚ùå Erreur r√©cup√©ration donn√©es:', error);
    });
})();
</script>
